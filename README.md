# CopilotNode RPA Web - 可视化自动化工具

基于Web的图像识别RPA(机器人流程自动化)工具，采用类似ComfyUI的节点编辑器界面，支持可视化编辑和实时执行。通过直观的拖拽操作创建复杂的自动化工作流。

## ✨ 主要特性

- **🌐 现代Web界面**: 无需安装，浏览器即用的现代化界面
- **🎨 可视化节点编辑**: 类似ComfyUI的拖拽式节点连接界面，支持LiteGraph.js框架
- **🖼️ 智能图像识别**: 基于OpenCV的高精度图像匹配和模板识别，支持边界区域限制
- **⚡ 实时执行监控**: 支持实时播放、暂停、停止，可视化执行进度
- **🔀 条件分支逻辑**: 支持IF条件判断，实现智能决策流程
- **💾 多画图项目管理**: 支持项目内多个画图管理，独立配置和执行
- **📐 操作边界控制**: 为每个画图设置专用操作边界，提高自动化精度和安全性
- **📁 多选节点操作**: 支持Ctrl多选、框选、批量删除等高级操作
- **📱 响应式设计**: 支持不同屏幕尺寸，适配各种设备
- **🔧 标准化节点**: 基于LiteGraph标准实现，支持右键resize和属性同步
- **🔗 智能连接保存**: 节点连接关系完整保存和恢复，支持复杂工作流

## 🚀 快速开始

### 1. 环境要求

- **Python**: 3.7+ 
- **操作系统**: Windows/Linux/MacOS
- **浏览器**: Chrome 90+, Firefox 88+, Safari 14+
- **分辨率**: 1280x720或更高

### 2. 安装依赖
安装conda环境：
```bash
# 1. 下载Miniconda安装脚本
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
# 2. 运行安装脚本
bash Miniconda3-latest-Linux-x86_64.sh
# 3. 按照提示进行安装
# 4. 重新加载bash配置
source ~/.bashrc
# 5. 验证安装
conda --version
```

```bash
# 方法1：使用pip安装项目依赖
pip install -r requirements.txt

# 方法2：使用Python 3安装  项目依赖
pip3 install -r requirements.txt

# 方法3：在虚拟环境中安装
python -m venv copilotnode_env
source copilotnode_env/bin/activate  # Windows: copilotnode_env\Scripts\activate
pip install -r requirements.txt
```

### 3. 启动服务

```bash
python app.py
```

### 4. 打开浏览器

访问 `http://localhost:5000` 开始使用

## 📦 节点类型详解

### 🎯 动作节点 (Action Nodes)

| 节点类型 | 功能描述 | 主要参数 | 特殊功能 |
|---------|---------|---------|----------|
| **点击** | 在指定坐标点击鼠标 | x, y 坐标, 随机范围 | 支持随机偏移避免检测 |
| **移动** | 移动鼠标到指定位置 | x, y 坐标, 时长, 速度因子 | 支持平滑移动轨迹 |
| **键盘** | 发送键盘输入或按键 | 文本内容/按键组合 | 支持特殊按键和组合键 |
| **等待** | 暂停执行指定时间 | 等待时间(秒) | 支持随机时长 |

### 🖼️ 图像识别节点 (Image Nodes)

| 节点类型 | 功能描述 | 主要参数 | 输出 |
|---------|---------|---------|------|
| **查找图像** | 在屏幕上查找指定图像 | 图像文件, 匹配度阈值 | 找到状态, 位置坐标 |
| **点击图像** | 查找图像并点击 | 图像文件, 匹配度, 随机偏移 | 执行流程 |
| **跟随图像** | 移动鼠标到图像位置 | 图像文件, 匹配度 | 执行流程 |

### 🔀 逻辑控制节点 (Logic Nodes)

| 节点类型 | 功能描述 | 条件类型 | 用途 |
|---------|---------|----------|------|
| **IF条件** | 根据条件执行分支逻辑 | 图像存在/节点结果 | 智能决策，错误处理 |
| **连接** | 流程连接控制 | - | 复杂分支连接 |

## 💡 使用指南

### 项目和画图管理

1. **创建项目**: 点击"新建"按钮创建项目，设置项目名称和描述
2. **选择项目**: 从项目下拉列表选择要工作的项目
3. **创建画图**: 在画图管理器中点击"+"创建新画图，可设置初始边界
4. **选择画图**: 点击左侧画图列表中的画图项目进行切换
5. **边界设置**: 选中画图后，在右侧属性面板配置操作边界范围
6. **多画图管理**: 每个项目可包含多个独立的画图工作流

### 创建工作流

1. **选择画图**: 确保已选择要编辑的画图
2. **添加节点**: 从左侧节点面板拖拽节点到画布
3. **设置参数**: 在右侧属性面板配置节点参数
4. **连接节点**: 拖拽节点输出端口到下一个节点的输入端口
5. **多选操作**: 按住Ctrl点击或框选多个节点进行批量操作
6. **节点调整**: 右键节点选择resize重置大小
7. **自动保存**: 画图会自动保存，也可手动保存

### 执行工作流

1. **播放控制**: 点击播放按钮开始执行，支持暂停/停止
2. **循环播放**: 勾选循环播放复选框实现重复执行
3. **速度调节**: 使用速度滑块调整执行速度(0.5x-3.0x)
4. **实时监控**: 查看当前执行状态、进度和节点信息
5. **错误处理**: 支持执行错误提示和中断处理

### 图像识别配置

1. **上传图像**: 点击图像节点的上传按钮，支持已有图像选择和新图像上传
2. **格式支持**: PNG、JPG、JPEG等常见格式
3. **匹配精度**: 调整匹配度阈值(0.1-1.0)，建议0.8
4. **随机偏移**: 设置点击位置的随机偏移范围
5. **边界限制**: 图像识别会在设置的画图边界内进行，提高精度和性能

### IF条件节点使用

1. **图像存在检查**: 检测界面元素是否出现
2. **节点结果检查**: 基于其他节点执行结果判断
3. **分支连接**: 手动配置true/false分支的后续节点
4. **复杂逻辑**: 通过多个IF节点组合实现复杂判断

## 🛠️ 技术架构

### 后端技术栈
- **Flask**: Web框架和RESTful API服务器
- **OpenCV**: 图像识别和计算机视觉处理
- **PyAutoGUI**: 跨平台GUI自动化操作
- **Threading**: 多线程执行引擎支持
- **Pillow**: 图像处理和格式转换
- **NumPy**: 数值计算和数组操作

### 前端技术栈
- **LiteGraph.js**: 专业的节点编辑器框架
- **原生JavaScript ES6+**: 无框架依赖，性能优化
- **CSS Grid/Flexbox**: 现代响应式布局
- **Canvas绘图**: 高性能节点渲染
- **Drag & Drop API**: 直观的拖拽交互
- **WebSocket**: 实时状态通信(计划中)

## 📂 项目结构

```
CopilotNode/
├── app.py                    # Flask后端服务器和执行引擎
├── image_recognition.py      # OpenCV图像识别核心模块，支持区域搜索
├── utils.py                  # 工具函数和辅助方法
├── requirements.txt          # Python项目依赖列表
├── README.md                # 项目文档和使用指南
├── USAGE.md                 # 详细使用说明和功能介绍
│
├── core/                    # 核心功能模块
│   ├── config.py           # 全局配置和常量定义
│   └── state.py            # 全局状态管理
│
├── services/               # 业务服务层
│   ├── execution_service.py    # 执行引擎服务
│   ├── project_service.py      # 项目管理服务
│   └── drawing_service.py      # 画图管理服务，支持边界控制
│
├── api/                    # API路由模块
│   ├── projects.py         # 项目相关API接口
│   └── drawings.py         # 画图相关API接口
│
├── web/                    # 前端Web应用文件
│   ├── index.html          # 主页面HTML结构，优化的UI布局
│   ├── style.css           # CSS样式和响应式布局，支持边界设置UI
│   ├── script.js           # 主应用逻辑和Canvas交互
│   ├── drawing-manager.js  # 画图管理器，多画图支持
│   ├── debug.js            # 调试工具和日志管理
│   ├── litegraph.js-release/ # LiteGraph.js节点编辑器框架
│   ├── nodes/              # 节点类型定义模块
│   │   ├── index.js        # 节点模块入口文件
│   │   ├── action-nodes.js # 动作节点(点击、移动、键盘、等待)
│   │   ├── image-nodes.js  # 图像识别节点，支持边界识别
│   │   ├── logic-nodes.js  # 逻辑控制节点(IF、连接)
│   │   └── README.md       # 节点开发文档
│   └── imgs/              # UI图标和界面素材
│
├── projects/              # 项目存储目录（结构化存储）
│   ├── [project-uuid]/    # 项目目录（按UUID组织）
│   │   ├── project.json   # 项目元数据
│   │   └── drawings/      # 画图文件存储
│   │       └── [drawing-uuid].json # 具体画图文件
│   └── ...
│
├── uploads/               # 用户上传的图像文件存储
├── testimg/              # 测试用例图像文件
│
└── __pycache__/          # Python字节码缓存
```

## 🔌 API接口文档

后端提供完整的RESTful API接口：

### 项目管理API
- `GET /api/projects` - 获取所有项目列表
- `POST /api/projects` - 创建新项目
- `GET /api/projects/<id>` - 获取指定项目详情
- `POST /api/projects/<id>/activate` - 激活指定项目
- `GET /api/projects/active` - 获取当前活跃项目

### 画图管理API
- `GET /api/drawings` - 获取当前项目的所有画图
- `POST /api/drawings` - 创建新画图
- `GET /api/drawings/<id>` - 获取指定画图详情
- `POST /api/drawings/<id>/save` - 保存画图内容
- `POST /api/drawings/<id>/boundary` - 设置画图边界
- `DELETE /api/drawings/<id>` - 删除指定画图

### 执行控制API
- `POST /api/drawings/<id>/execute` - 执行指定画图
- `DELETE /api/drawings/<id>/execute` - 停止画图执行
- `GET /api/drawings/<id>/status` - 获取画图执行状态

### 文件管理API
- `POST /api/upload` - 上传图像文件
- `GET /api/images` - 获取可用图像列表
- `DELETE /api/images/<filename>` - 删除图像文件

## 🎯 使用示例

### 基础自动化流程

1. **简单点击序列**:
   ```
   点击(100,200) → 等待(1秒) → 点击(300,400) → 结束
   ```

2. **图像驱动自动化**:
   ```
   查找图像(login_btn.png) → 点击图像 → 键盘输入(用户名) → 点击图像(submit.png)
   ```

3. **条件分支处理**:
   ```
   IF(错误图标存在) → 真:处理错误流程 → 恢复操作
                  → 假:继续正常流程
   ```

### 高级功能演示

查看 `examples/` 目录中的示例项目：
- **sample_project.json**: 基础功能演示
- **if_demo_project.json**: 条件逻辑演示  
- **README_IF_DEMO.md**: 详细的IF条件使用教程

## ⚙️ 配置说明

### 服务器配置

在 `app.py` 中可配置：
```python
# 服务器绑定地址和端口
app.run(host='0.0.0.0', port=5000, debug=True)

# PyAutoGUI安全设置
pyautogui.FAILSAFE = True  # 鼠标移至屏幕角落停止执行
pyautogui.PAUSE = 0.1     # 动作间默认暂停时间
```

### 图像识别参数

- **匹配阈值**: 0.1-1.0，建议0.8以上获得较好精度
- **搜索区域**: 可限制在屏幕特定区域以提高速度
- **多尺度匹配**: 支持不同缩放比例的图像识别

## 🛡️ 安全注意事项

⚠️ **重要提醒**:

1. **系统权限**: 本工具具有完整的系统控制权限，请谨慎使用
2. **网络安全**: 默认绑定所有网络接口，生产环境建议修改为localhost
3. **文件安全**: 上传的图像文件存储在本地`uploads/`目录，定期清理
4. **防火墙**: 建议在防火墙保护下运行，不要暴露到公网
5. **失效保护**: PyAutoGUI的FAILSAFE功能已启用，紧急情况下移动鼠标到屏幕角落可停止执行
6. **备份数据**: 重要项目文件请及时备份，避免意外丢失

## 🚀 性能优化

### 图像识别优化
- 使用高对比度、特征明显的图像模板
- 适当裁剪图像，去除不必要的背景
- 根据屏幕分辨率调整图像尺寸
- 设置合适的搜索区域减少计算量

### 执行性能优化  
- 合理设置等待时间，避免过快操作
- 使用随机偏移避免被检测为机器人
- 监控CPU和内存使用，避免资源过载
- 长时间运行时定期重启清理内存

## 🔧 开发指南

### 添加新节点类型

1. **定义节点类**: 在 `web/nodes/` 目录下对应文件中添加节点类定义
2. **实现执行逻辑**: 在 `app.py` 的 `execute_action` 函数中添加处理逻辑
3. **注册节点类型**: 使用 `LiteGraph.registerNodeType()` 注册新节点
4. **更新UI**: 在前端节点面板中添加新节点入口

### 自定义主题样式

修改 `web/style.css` 中的CSS变量：

```css
:root {
    --primary-color: #007bff;        /* 主色调 */
    --background-color: #1a1a1a;     /* 背景色 */
    --node-color: #3d3d3d;           /* 节点颜色 */
    --text-color: #ffffff;           /* 文字颜色 */
    --accent-color: #28a745;         /* 强调色 */
}
```

### 扩展图像识别功能

在 `image_recognition.py` 中可扩展：
- 多模板匹配
- OCR文字识别
- 颜色检测
- 形状识别
- 深度学习模型集成

## 🐛 常见问题

### Q: 图像识别失败怎么办？
**A**: 
1. 检查图像质量和特征明显程度
2. 调整匹配阈值(降低到0.6-0.7)
3. 确认屏幕分辨率和图像尺寸匹配
4. 尝试重新截取更清晰的模板图像

### Q: 执行速度太快/太慢？
**A**: 
1. 使用速度滑块调整执行倍速
2. 在等待节点中设置合适的延迟时间
3. 修改 `pyautogui.PAUSE` 全局暂停时间
4. 考虑目标应用的响应时间

### Q: 节点连接后不执行或连接丢失？
**A**: 
1. 检查节点连接线是否正确显示
2. 确认起始节点没有输入端口
3. 查看浏览器控制台的错误信息
4. 验证IF条件节点的分支配置
5. 重新加载画图检查连接是否保存

### Q: 浏览器兼容性问题？
**A**: 
1. 使用Chrome 90+或Firefox 88+
2. 启用JavaScript和Canvas支持
3. 检查是否阻止了跨域请求
4. 尝试无痕模式排除扩展插件干扰

## 📈 路线图

### v2.2.0 (规划中)
- [ ] 画图执行历史记录和回放
- [ ] 节点组和子图功能
- [ ] 更多图像识别算法（OCR、特征匹配）
- [ ] 录制模式自动生成节点
- [ ] WebSocket实时通信
- [ ] 移动端适配

### v2.3.0 (未来版本)
- [ ] 插件系统和第三方节点
- [ ] 云端项目同步
- [ ] 团队协作功能
- [ ] 性能分析和优化工具
- [ ] AI辅助节点生成

## 📄 许可证

MIT License - 详见LICENSE文件

## 🤝 贡献指南

欢迎提交Issue和Pull Request！

### 贡献步骤
1. Fork本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送分支 (`git push origin feature/AmazingFeature`)
5. 打开Pull Request

### 代码规范
- Python代码遵循PEP 8规范
- JavaScript使用ES6+标准
- 提交信息使用英文，格式：`type(scope): description`

## 📞 支持与反馈

- 🐛 **Bug报告**: 请在GitHub Issues中详细描述问题
- 💡 **功能建议**: 欢迎在Issues中提出新功能想法
- 📖 **文档改进**: 发现文档问题请提交PR
- ❓ **使用咨询**: 可在Discussions中交流使用心得

## 🎉 更新日志

### v2.1.0 (当前版本)
- ✨ **重大架构升级**: 引入项目和画图的分层管理架构
- ✨ **多画图支持**: 每个项目可包含多个独立的画图工作流
- ✨ **智能边界控制**: 为每个画图设置专用操作边界，图像识别限制在边界内
- ✨ **完善连接保存**: 修复节点连接丢失问题，支持复杂工作流的完整保存和恢复
- ✨ **优化UI布局**: 边界设置移至右侧属性面板，采用纵向布局适配小屏幕
- ✨ **增强图像识别**: 支持边界区域内的精确图像搜索，提高识别效率
- ✨ **改进项目管理**: 结构化项目存储，支持UUID标识和元数据管理
- 🐛 修复画图选择时属性面板不更新的问题
- 🐛 解决启动时默认读取画图的问题
- 🐛 优化画图管理器的状态同步

### v2.0.1
- ✨ 修复节点选择逻辑，避免自动形成节点组
- ✨ 完善IF条件节点分支执行机制
- ✨ 添加标准化节点属性同步功能
- ✨ 改进图像节点的参数验证和错误处理
- ✨ 增强多选节点操作体验
- 🐛 修复右键resize功能
- 🐛 解决节点属性加载后显示不同步问题
- 🐛 消除JavaScript警告和错误

### v2.0.0 
- ✨ 全新Web界面替代桌面GUI
- 🎨 集成LiteGraph.js专业节点编辑器
- ⚡ 实时执行状态监控和进度显示
- 📁 支持.json和.acp项目文件格式
- 🖼️ 拖拽式图像上传和管理
- 📱 完全响应式设计支持
- 🔀 强化IF条件节点和分支逻辑
- 🛠️ 标准化节点开发框架

---

**CopilotNode RPA Web** - 让自动化更简单，让效率更高效！ 🚀